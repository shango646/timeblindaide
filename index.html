<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Timeblind Aide</title>
<meta name="description" content="Plan backwards. Live forwards. A time blindness tool for managing your day.">
<meta name="theme-color" content="#0c0c0e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Timeblind Aide">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Fraunces:ital,wght@0,200;0,400;0,600;1,200;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0c0c0e; --surface: #161618; --surface2: #1e1e21;
  --border: #272729; --border2: #323235;
  --accent: #e2c97e; --accent2: #b89f5c;
  --text: #ede9e0; --muted: #5a5755; --muted2: #7a7673;
  --danger: #e07060; --warn: #e09050; --green: #7ab87a;
  --buffer: #2a3a2a; --buffer-border: #3d5c3d;
  --block-fixed: #1e2535; --block-fixed-border: #2d3d5a;
  --block-flex: #251e35; --block-flex-border: #3d2d5a;
  --flex-accent: #a07ee0;
}
body { background:var(--bg); color:var(--text); font-family:'DM Mono',monospace; min-height:100vh; padding:0 0 80px; max-width:480px; margin:0 auto; }

.header { padding:24px 20px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:flex-end; }
.header h1 { font-family:'Fraunces',serif; font-weight:200; font-size:26px; color:var(--accent); letter-spacing:-0.5px; line-height:1; }
.header h1 em { font-style:italic; font-weight:400; }
.header-tagline { font-size:10px; color:var(--muted2); letter-spacing:0.08em; margin-top:6px; font-style:italic; line-height:1.4; }
.clock-block { text-align:right; }
.clock { font-size:22px; font-weight:500; color:var(--accent); font-variant-numeric:tabular-nums; letter-spacing:-0.5px; }
.date-label { font-size:10px; color:var(--muted2); letter-spacing:0.08em; margin-top:2px; }

.start-mode-bar { margin:12px 20px 0; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px 14px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.start-mode-label { font-size:9px; color:var(--muted2); letter-spacing:0.1em; text-transform:uppercase; flex-shrink:0; }
.mode-btns { display:flex; gap:6px; flex:1; }
.mode-btn { flex:1; background:var(--bg); border:1px solid var(--border2); border-radius:6px; color:var(--muted2); font-family:'DM Mono',monospace; font-size:10px; padding:6px 8px; cursor:pointer; text-align:center; transition:all 0.2s; white-space:nowrap; }
.mode-btn.active { background:var(--surface2); border-color:var(--accent2); color:var(--accent); }
.preset-time-wrap { display:none; width:100%; margin-top:8px; gap:8px; align-items:center; }
.preset-time-wrap.visible { display:flex; }
.preset-time-wrap input[type="time"] { flex:1; font-size:15px; padding:8px 12px; }
.preset-apply-btn { background:var(--accent2); color:var(--bg); border:none; border-radius:6px; font-family:'DM Mono',monospace; font-size:11px; font-weight:500; padding:8px 14px; cursor:pointer; transition:background 0.2s; white-space:nowrap; }
.preset-apply-btn:hover { background:var(--accent); }
.preset-active-label { font-size:10px; color:var(--accent2); width:100%; margin-top:4px; font-style:italic; }

.buffer-summary { margin:16px 20px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px 16px; display:flex; }
.buf-stat { flex:1; text-align:center; padding:0 8px; border-right:1px solid var(--border); }
.buf-stat:last-child { border-right:none; }
.buf-stat .val { font-size:20px; font-weight:500; font-variant-numeric:tabular-nums; line-height:1; }
.buf-stat .val.good { color:var(--green); }
.buf-stat .val.warn { color:var(--warn); }
.buf-stat .val.danger { color:var(--danger); animation:pulse 1.5s ease-in-out infinite; }
.buf-stat .lbl { font-size:9px; color:var(--muted2); letter-spacing:0.1em; text-transform:uppercase; margin-top:4px; }

.alert-banner { margin:0 20px 16px; background:#2a1a1a; border:1px solid #7a3030; border-radius:10px; padding:10px 14px; font-size:11px; color:var(--danger); display:flex; align-items:center; gap:8px; animation:pulse 2s ease-in-out infinite; }

.timeline-wrap { margin:0 20px 16px; }
.timeline-heading { font-size:9px; color:var(--muted); letter-spacing:0.12em; text-transform:uppercase; margin-bottom:8px; }
.timeline-bar { height:36px; background:var(--surface); border:1px solid var(--border); border-radius:8px; position:relative; overflow:hidden; }
.tl-segment { position:absolute; top:0; height:100%; display:flex; align-items:center; justify-content:center; font-size:9px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; padding:0 4px; transition:all 0.4s ease; }
.tl-segment.block-fixed-seg { background:var(--block-fixed); border-right:1px solid var(--block-fixed-border); color:#8aaddd; }
.tl-segment.block-flex-seg { background:var(--block-flex); border-right:1px solid var(--block-flex-border); color:#b08ae0; background-image:repeating-linear-gradient(45deg,transparent,transparent 4px,rgba(160,126,224,0.08) 4px,rgba(160,126,224,0.08) 8px); }
.tl-segment.buffer-seg { background:var(--buffer); border-right:1px solid var(--buffer-border); color:#6a9a6a; }
.tl-segment.past-seg { background:#141414; border-right:1px solid #1e1e1e; color:var(--muted); }
.tl-now-line { position:absolute; top:0; width:2px; height:100%; background:var(--accent); z-index:10; transition:left 1s linear; }
.tl-now-line::after { content:''; position:absolute; top:-3px; left:-3px; width:8px; height:8px; border-radius:50%; background:var(--accent); }
.tl-labels { display:flex; justify-content:space-between; margin-top:4px; }
.tl-label { font-size:9px; color:var(--muted); }

.legend { display:flex; gap:14px; margin:-4px 20px 16px; flex-wrap:wrap; }
.legend-item { display:flex; align-items:center; gap:5px; font-size:9px; color:var(--muted2); }
.legend-dot { width:10px; height:10px; border-radius:2px; flex-shrink:0; }
.legend-dot.fixed { background:var(--block-fixed); border:1px solid var(--block-fixed-border); }
.legend-dot.flex { background:var(--block-flex); border:1px solid var(--block-flex-border); background-image:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(160,126,224,0.2) 2px,rgba(160,126,224,0.2) 4px); }
.legend-dot.buf { background:var(--buffer); border:1px solid var(--buffer-border); }

/* ALERTS TOGGLE */
.alerts-bar { margin:0 20px 16px; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:13px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
.alerts-label strong { color:var(--text); font-weight:500; display:block; font-size:11px; margin-bottom:2px; }
.alerts-label span { font-size:10px; color:var(--muted2); }
.toggle-switch { position:relative; width:40px; height:23px; flex-shrink:0; }
.toggle-switch input { opacity:0; width:0; height:0; }
.toggle-slider { position:absolute; inset:0; background:var(--border2); border-radius:23px; cursor:pointer; transition:background 0.2s; }
.toggle-slider::before { content:''; position:absolute; width:17px; height:17px; left:3px; top:3px; background:var(--muted); border-radius:50%; transition:transform 0.2s,background 0.2s; }
.toggle-switch input:checked + .toggle-slider { background:#2a3d2a; }
.toggle-switch input:checked + .toggle-slider::before { transform:translateX(17px); background:var(--green); }

/* SHARE */
.share-bar { margin:0 20px 20px; }
.share-btn { width:100%; background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:13px 16px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; transition:border-color 0.2s; font-family:'DM Mono',monospace; }
.share-btn:hover { border-color:var(--accent2); }
.share-btn-label { font-size:11px; color:var(--muted2); }
.share-btn-icon { font-size:16px; color:var(--muted); }
.share-output { margin-top:10px; display:none; }
.share-output.visible { display:block; }
.share-text-box { background:var(--bg); border:1px solid var(--border2); border-radius:8px; padding:14px; font-size:11px; line-height:1.9; color:var(--text); white-space:pre-wrap; font-family:'DM Mono',monospace; }
.share-actions { display:flex; gap:8px; margin-top:8px; }
.share-copy-btn { flex:1; padding:10px; border-radius:7px; border:none; background:var(--accent); color:var(--bg); font-family:'DM Mono',monospace; font-size:11px; font-weight:500; cursor:pointer; transition:background 0.2s; }
.share-copy-btn:hover { background:var(--accent2); }
.share-close-btn { flex:1; padding:10px; border-radius:7px; background:var(--surface2); color:var(--muted2); border:1px solid var(--border); font-family:'DM Mono',monospace; font-size:11px; cursor:pointer; }

/* ADD FORM */
.add-section { margin:0 20px 20px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; }
.form-row { margin-bottom:14px; }
.form-label { font-size:9px; color:var(--muted2); letter-spacing:0.1em; text-transform:uppercase; margin-bottom:6px; display:block; }
input[type="text"], input[type="time"], input[type="number"] { width:100%; background:var(--bg); border:1px solid var(--border2); border-radius:8px; color:var(--text); font-family:'DM Mono',monospace; font-size:14px; padding:10px 12px; outline:none; transition:border-color 0.2s; -webkit-appearance:none; }
input[type="time"] { font-size:17px; font-weight:500; color:var(--accent); }
input:focus { border-color:var(--accent2); }
input::placeholder { color:var(--muted); }
.toggle-row { display:flex; gap:8px; margin-bottom:14px; }
.toggle-btn { flex:1; background:var(--bg); border:1px solid var(--border2); border-radius:8px; color:var(--muted2); font-family:'DM Mono',monospace; font-size:11px; padding:8px; cursor:pointer; text-align:center; transition:all 0.2s; }
.toggle-btn.active { background:var(--surface2); border-color:var(--accent2); color:var(--accent); }
.toggle-btn.active-flex { background:#1e1830; border-color:var(--flex-accent); color:var(--flex-accent); }
.collapsible { display:none; margin-bottom:14px; }
.collapsible.visible { display:block; }
button.add-btn { width:100%; background:var(--accent); color:var(--bg); border:none; border-radius:8px; font-family:'DM Mono',monospace; font-size:13px; font-weight:500; padding:12px; cursor:pointer; letter-spacing:0.04em; transition:background 0.2s,transform 0.1s; margin-top:4px; }
button.add-btn:hover { background:var(--accent2); }
button.add-btn:active { transform:scale(0.98); }

/* BLOCKS */
.blocks-heading { font-size:9px; color:var(--muted); letter-spacing:0.12em; text-transform:uppercase; margin:0 20px 10px; }
.blocks-list { display:flex; flex-direction:column; margin:0 20px; }
.block-card { position:relative; border-radius:0; overflow:hidden; transition:all 0.3s; }
.block-card:first-child { border-radius:12px 12px 0 0; }
.block-card:last-child { border-radius:0 0 12px 12px; }
.block-card:only-child { border-radius:12px; }
.block-inner { background:var(--block-fixed); border:1px solid var(--block-fixed-border); border-bottom:none; padding:14px 16px; }
.block-card.flex-type .block-inner { background:var(--block-flex); border-color:var(--block-flex-border); border-style:dashed; }
.block-card:last-child .block-inner, .block-card:only-child .block-inner { border-bottom:1px solid var(--block-fixed-border); }
.block-card.flex-type:last-child .block-inner, .block-card.flex-type:only-child .block-inner { border-bottom:1px dashed var(--block-flex-border); }
.block-card.past .block-inner { background:#111113; border-color:#1e1e22; opacity:0.5; }
.block-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
.block-left { display:flex; align-items:flex-start; gap:8px; flex:1; min-width:0; }
.type-icon { font-size:13px; margin-top:2px; flex-shrink:0; opacity:0.6; }
.block-name { font-family:'Fraunces',serif; font-weight:400; font-size:16px; color:var(--text); line-height:1.2; }
.block-meta { font-size:10px; color:var(--muted2); margin-top:2px; }
.block-type-badge { font-size:8px; letter-spacing:0.1em; text-transform:uppercase; margin-top:3px; opacity:0.7; }
.block-type-badge.fixed { color:#8aaddd; }
.block-type-badge.flex { color:var(--flex-accent); }
.edit-time-btn { background:none; border:1px solid var(--border2); border-radius:5px; color:var(--muted2); cursor:pointer; font-size:9px; padding:3px 7px; margin-top:5px; font-family:'DM Mono',monospace; transition:all 0.2s; display:inline-block; }
.edit-time-btn:hover { border-color:var(--flex-accent); color:var(--flex-accent); }
.block-right { text-align:right; flex-shrink:0; padding-left:10px; }
.block-countdown { font-size:22px; font-weight:500; font-variant-numeric:tabular-nums; color:var(--accent); letter-spacing:-0.5px; line-height:1; }
.block-card.urgent .block-countdown { color:var(--danger); animation:pulse 1.5s ease-in-out infinite; }
.block-card.warning .block-countdown { color:var(--warn); }
.block-card.past .block-countdown { color:var(--green); font-size:14px; }
.block-status { font-size:9px; color:var(--muted2); letter-spacing:0.08em; text-transform:uppercase; margin-top:2px; }
.del-btn { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; line-height:1; padding:2px 0 2px 8px; transition:color 0.2s; flex-shrink:0; }
.del-btn:hover { color:var(--danger); }

/* INLINE EDIT */
.inline-edit { display:none; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
.inline-edit.open { display:block; }
.inline-edit-row { display:flex; gap:8px; align-items:center; }
.inline-edit-row input[type="time"] { flex:1; font-size:14px; padding:8px 10px; }
.inline-save { background:var(--accent); color:var(--bg); border:none; border-radius:6px; font-family:'DM Mono',monospace; font-size:11px; font-weight:500; padding:8px 12px; cursor:pointer; white-space:nowrap; }
.inline-save:hover { background:var(--accent2); }
.inline-cancel { background:none; border:1px solid var(--border2); border-radius:6px; color:var(--muted2); font-family:'DM Mono',monospace; font-size:11px; padding:8px 10px; cursor:pointer; }
.inline-note { font-size:9px; color:var(--danger); margin-top:6px; display:none; }

.progress-track { height:3px; background:var(--border); overflow:hidden; }
.progress-fill { height:100%; background:var(--accent); transition:width 1s linear,background 0.5s; }
.block-card.urgent .progress-fill { background:var(--danger); }
.block-card.warning .progress-fill { background:var(--warn); }
.block-card.past .progress-fill { background:var(--green); width:100%!important; }
.block-card.flex-type .progress-fill { background:var(--flex-accent); }

.buffer-connector { background:var(--buffer); border-left:1px solid var(--buffer-border); border-right:1px solid var(--buffer-border); padding:8px 16px; display:flex; justify-content:space-between; align-items:center; }
.buffer-connector.danger-buf { background:#2a1a1a; border-color:#5a2a2a; }
.buffer-connector.warn-buf { background:#2a2218; border-color:#5a4a28; }
.buf-label { font-size:9px; color:#6a9a6a; letter-spacing:0.1em; text-transform:uppercase; }
.buf-time { font-size:13px; font-weight:500; color:#7ab87a; font-variant-numeric:tabular-nums; }
.buffer-connector.danger-buf .buf-label, .buffer-connector.danger-buf .buf-time { color:var(--danger); }
.buffer-connector.warn-buf .buf-label, .buffer-connector.warn-buf .buf-time { color:var(--warn); }

.empty { text-align:center; padding:40px 20px; color:var(--muted); font-size:11px; line-height:2; border:1px dashed var(--border); border-radius:12px; margin:0 20px; }
.empty .icon { font-size:28px; margin-bottom:12px; opacity:0.4; }

.tip-footer { margin:32px 20px 0; padding:18px 20px; background:var(--surface); border:1px solid var(--border); border-radius:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
.tip-text .tip-title { font-family:'Fraunces',serif; font-weight:300; font-size:14px; color:var(--text); margin-bottom:3px; }
.tip-text .tip-sub { font-size:10px; color:var(--muted2); line-height:1.5; }
.tip-btn { background:#ff5e5b; color:white; border:none; border-radius:8px; font-family:'DM Mono',monospace; font-size:12px; font-weight:500; padding:10px 16px; cursor:pointer; text-decoration:none; display:inline-block; white-space:nowrap; transition:background 0.2s,transform 0.1s; flex-shrink:0; }
.tip-btn:hover { background:#e04d4a; }
.tip-made-by { text-align:center; margin:14px 20px 0; font-size:9px; color:var(--muted); letter-spacing:0.08em; }

.toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--surface); border:1px solid var(--accent2); border-radius:8px; padding:10px 20px; font-size:12px; color:var(--accent); opacity:0; transition:opacity 0.3s,transform 0.3s; pointer-events:none; z-index:999; white-space:nowrap; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.45} }
@keyframes ringPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)} }
.block-card.ringing .block-inner { animation:ringPulse 0.4s ease-in-out 4; }
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>Timeblind<br><em>Aide</em></h1>
    <p class="header-tagline">Plan backwards.<br>Live forwards.</p>
  </div>
  <div class="clock-block">
    <div class="clock" id="clock">‚Äî</div>
    <div class="date-label" id="dateLabel">‚Äî</div>
  </div>
</div>

<div class="start-mode-bar">
  <span class="start-mode-label">Start from</span>
  <div class="mode-btns">
    <div class="mode-btn active" id="modeNow" onclick="setStartMode('now')">‚è± Current time</div>
    <div class="mode-btn" id="modePreset" onclick="setStartMode('preset')">üïê Preset time</div>
  </div>
  <div class="preset-time-wrap" id="presetWrap">
    <input type="time" id="presetTimeInput" />
    <button class="preset-apply-btn" onclick="applyPreset()">Set</button>
  </div>
  <div class="preset-active-label" id="presetActiveLabel" style="display:none"></div>
</div>

<div class="buffer-summary">
  <div class="buf-stat"><div class="val good" id="statBlocked">‚Äî</div><div class="lbl">Blocked</div></div>
  <div class="buf-stat"><div class="val good" id="statBuffer">‚Äî</div><div class="lbl">Buffer</div></div>
  <div class="buf-stat"><div class="val good" id="statNext">‚Äî</div><div class="lbl">Next event</div></div>
</div>

<div class="alert-banner" id="alertBanner" style="display:none">‚ö†Ô∏è <span id="alertText"></span></div>

<div class="timeline-wrap">
  <div class="timeline-heading">Today's timeline</div>
  <div class="timeline-bar" id="timelineBar"><div class="tl-now-line" id="nowLine" style="left:0%"></div></div>
  <div class="tl-labels">
    <span class="tl-label" id="tlStart">‚Äî</span>
    <span class="tl-label" id="tlMid">‚Äî</span>
    <span class="tl-label" id="tlEnd">‚Äî</span>
  </div>
</div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot fixed"></div> Fixed üîí</div>
  <div class="legend-item"><div class="legend-dot flex"></div> Flexible ‚úèÔ∏è</div>
  <div class="legend-item"><div class="legend-dot buf"></div> Buffer</div>
</div>

<div class="alerts-bar">
  <div class="alerts-label">
    <strong>üîî Event alerts</strong>
    <span>Sound + vibration 5 min before each event</span>
  </div>
  <label class="toggle-switch">
    <input type="checkbox" id="alertsToggle" onchange="toggleAlerts(this.checked)">
    <span class="toggle-slider"></span>
  </label>
</div>

<div class="share-bar">
  <button class="share-btn" onclick="toggleShare()">
    <span class="share-btn-label">üì§ Share your day</span>
    <span class="share-btn-icon">‚Ä∫</span>
  </button>
  <div class="share-output" id="shareOutput">
    <div class="share-text-box" id="shareText"></div>
    <div class="share-actions">
      <button class="share-copy-btn" onclick="copyShare()">üìã Copy to clipboard</button>
      <button class="share-close-btn" onclick="toggleShare()">Close</button>
    </div>
  </div>
</div>

<div class="add-section">
  <div class="form-row">
    <label class="form-label">Event name</label>
    <input type="text" id="eventName" placeholder="e.g. Doctor's appointment" />
  </div>
  <div class="form-row">
    <label class="form-label">Start time</label>
    <input type="time" id="startTime" />
  </div>
  <div class="toggle-row">
    <div class="toggle-btn active" id="toggleNoDur" onclick="setDurMode(false)">Deadline only</div>
    <div class="toggle-btn" id="toggleDur" onclick="setDurMode(true)">+ Duration</div>
  </div>
  <div class="collapsible" id="durationField">
    <label class="form-label">Duration (minutes)</label>
    <input type="number" id="duration" placeholder="e.g. 45" min="1" max="480" />
  </div>
  <label class="form-label" style="margin-bottom:8px">Block type</label>
  <div class="toggle-row">
    <div class="toggle-btn active" id="toggleFixed" onclick="setBlockType('fixed')">üîí Fixed</div>
    <div class="toggle-btn" id="toggleFlex" onclick="setBlockType('flex')">‚úèÔ∏è Flexible</div>
  </div>
  <button class="add-btn" onclick="addBlock()">Ôºã Add to timeline</button>
</div>

<div class="blocks-heading">Your blocks</div>
<div id="blocksContainer"></div>

<div class="tip-footer">
  <div class="tip-text">
    <div class="tip-title">‚òï Find this helpful?</div>
    <div class="tip-sub">Built for the time blind, by someone who gets it.</div>
  </div>
  <a class="tip-btn" href="https://ko-fi.com/shangoshango" target="_blank" rel="noopener">Buy me a coffee</a>
</div>
<div class="tip-made-by">Timeblind Aide ¬∑ Plan backwards. Live forwards.</div>
<div class="toast" id="toast"></div>

<script>
let blocks = [];
let hasDuration = false;
let blockType = 'fixed';
let startMode = 'now';
let presetTime = null;
let alertsEnabled = false;
let alertedIds = new Set();
let audioCtx = null;
let editingId = null;

function pad(n) { return String(n).padStart(2,'0'); }
function formatTime(d) { return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function formatMins(m) {
  if(m<=0) return '0m';
  const h=Math.floor(m/60),mm=m%60;
  if(h>0&&mm>0) return `${h}h ${mm}m`;
  return h>0?`${h}h`:`${mm}m`;
}
function formatCountdown(ms) {
  if(ms<=0) return null;
  const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
  return h>0?`${h}:${pad(m)}:${pad(sec)}`:`${m}:${pad(sec)}`;
}
function getEffectiveNow() {
  return (startMode==='preset'&&presetTime!==null)?presetTime:Date.now();
}
function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.classList.remove('show'),2500);
}

// ‚îÄ‚îÄ OVERLAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function overlapsFixed(newStart, dur, excludeId) {
  const newEnd=newStart+dur*60000;
  return blocks.some(b=>{
    if(b.id===excludeId||b.type!=='fixed'||b.duration===0) return false;
    return newStart<(b.start+b.duration*60000)&&newEnd>b.start;
  });
}

// ‚îÄ‚îÄ START MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStartMode(mode) {
  startMode=mode;
  document.getElementById('modeNow').classList.toggle('active',mode==='now');
  document.getElementById('modePreset').classList.toggle('active',mode==='preset');
  document.getElementById('presetWrap').classList.toggle('visible',mode==='preset');
  if(mode==='now'){presetTime=null;document.getElementById('presetActiveLabel').style.display='none';}
  if(mode==='preset'){const n=new Date();document.getElementById('presetTimeInput').value=`${pad(n.getHours())}:${pad(n.getMinutes())}`;}
  render();
}
function applyPreset() {
  const val=document.getElementById('presetTimeInput').value;
  if(!val) return;
  const [h,m]=val.split(':').map(Number);
  const d=new Date(); d.setHours(h,m,0,0); presetTime=d.getTime();
  const lbl=document.getElementById('presetActiveLabel');
  lbl.textContent=`Planning from ${formatTime(d)}`; lbl.style.display='block';
  render();
}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setDurMode(on) {
  hasDuration=on;
  document.getElementById('toggleNoDur').classList.toggle('active',!on);
  document.getElementById('toggleDur').classList.toggle('active',on);
  document.getElementById('durationField').classList.toggle('visible',on);
}
function setBlockType(type) {
  blockType=type;
  document.getElementById('toggleFixed').className='toggle-btn'+(type==='fixed'?' active':'');
  document.getElementById('toggleFlex').className='toggle-btn'+(type==='flex'?' active-flex':'');
}
function addBlock() {
  const name=document.getElementById('eventName').value.trim()||'Event';
  const timeVal=document.getElementById('startTime').value;
  if(!timeVal){document.getElementById('startTime').focus();return;}
  const [h,m]=timeVal.split(':').map(Number);
  const start=new Date(); start.setHours(h,m,0,0);
  const durVal=parseInt(document.getElementById('duration').value)||0;
  const duration=hasDuration?durVal:0;
  if(blockType==='flex'&&duration>0&&overlapsFixed(start.getTime(),duration,null)){
    showToast('‚ö†Ô∏è Would overlap a fixed block ‚Äî adjust time'); return;
  }
  blocks.push({id:Date.now(),name,start:start.getTime(),duration,type:blockType,addedAt:Date.now()});
  blocks.sort((a,b)=>a.start-b.start);
  document.getElementById('eventName').value='';
  document.getElementById('duration').value='';
  render();
}
function removeBlock(id) {
  blocks=blocks.filter(b=>b.id!==id);
  alertedIds.delete(id);
  if(editingId===id) editingId=null;
  render();
}

// ‚îÄ‚îÄ INLINE EDIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEdit(id) {
  editingId=id; render();
  setTimeout(()=>{const i=document.getElementById(`et-${id}`);if(i)i.focus();},60);
}
function closeEdit() { editingId=null; render(); }
function saveEdit(id) {
  const inp=document.getElementById(`et-${id}`);
  if(!inp||!inp.value) return;
  const [h,m]=inp.value.split(':').map(Number);
  const d=new Date(); d.setHours(h,m,0,0);
  const block=blocks.find(b=>b.id===id);
  if(!block) return;
  if(block.type==='flex'&&block.duration>0&&overlapsFixed(d.getTime(),block.duration,id)){
    const note=document.getElementById(`en-${id}`);
    if(note) note.style.display='block'; return;
  }
  block.start=d.getTime();
  blocks.sort((a,b)=>a.start-b.start);
  alertedIds.delete(id);
  editingId=null; render();
}

// ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAlerts(on) {
  alertsEnabled=on;
  if(on) {
    try { audioCtx=new(window.AudioContext||window.webkitAudioContext)(); } catch(e){}
    showToast('üîî Alerts on ‚Äî 5 min warning before each event');
  } else { showToast('üîï Alerts off'); }
}
function playAlert() {
  if(navigator.vibrate) navigator.vibrate([200,80,200,80,400]);
  if(!audioCtx) { try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){return;} }
  try {
    [[440,0],[554,0.2],[659,0.4]].forEach(([freq,delay])=>{
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type='sine'; o.frequency.value=freq;
      const t=audioCtx.currentTime+delay;
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.3,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.001,t+0.35);
      o.start(t); o.stop(t+0.4);
    });
  } catch(e){}
}
function checkAlerts(sorted) {
  if(!alertsEnabled) return;
  const realNow=Date.now();
  sorted.forEach(b=>{
    if(alertedIds.has(b.id)) return;
    const ms=b.start-realNow;
    if(ms>0&&ms<=5*60*1000) {
      alertedIds.add(b.id);
      playAlert();
      showToast(`‚è∞ "${b.name}" in ${formatMins(Math.ceil(ms/60000))}!`);
      const card=document.querySelector(`[data-id="${b.id}"]`);
      if(card){card.classList.add('ringing');setTimeout(()=>card.classList.remove('ringing'),2000);}
    }
  });
}

// ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleShare() {
  const out=document.getElementById('shareOutput');
  if(!out.classList.contains('visible')){out.classList.add('visible');buildShareText();}
  else out.classList.remove('visible');
}
function buildShareText() {
  const now=getEffectiveNow();
  const sorted=[...blocks].sort((a,b)=>a.start-b.start);
  if(!sorted.length){document.getElementById('shareText').textContent='No events added yet.';return;}
  const today=new Date().toLocaleDateString([],{weekday:'long',month:'long',day:'numeric'});
  const lines=[`üìÖ My plan for ${today}:\n`];
  sorted.forEach((b,i)=>{
    const t=formatTime(new Date(b.start));
    const dur=b.duration>0?` (${formatMins(b.duration)})`:'';
    const flex=b.type==='flex'?' [flexible]':'';
    lines.push(`‚Ä¢ ${t} ‚Äî ${b.name}${dur}${flex}`);
    const nb=sorted[i+1];
    if(nb){const ce=b.duration>0?b.start+b.duration*60000:b.start;const gap=Math.round((nb.start-ce)/60000);if(gap>0)lines.push(`  ‚Ü≥ ${formatMins(gap)} buffer`);}
  });
  let tb=0,tbuf=0,prev=now;
  sorted.forEach(b=>{if(b.start>prev&&b.start>now)tbuf+=Math.round((b.start-prev)/60000);tb+=b.duration;prev=b.duration>0?b.start+b.duration*60000:b.start;});
  lines.push(`\n‚è± ${formatMins(tb)} blocked ¬∑ ${formatMins(tbuf)} buffer`);
  lines.push(`\nPlanned with Timeblind Aide`);
  document.getElementById('shareText').textContent=lines.join('\n');
}
function copyShare() {
  const text=document.getElementById('shareText').textContent;
  navigator.clipboard.writeText(text)
    .then(()=>showToast('‚úì Copied to clipboard!'))
    .catch(()=>{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showToast('‚úì Copied!');});
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const now=getEffectiveNow(), realNow=Date.now();
  const isPreset=startMode==='preset'&&presetTime!==null;
  document.getElementById('clock').textContent=formatTime(new Date(realNow));
  document.getElementById('dateLabel').textContent=new Date(realNow).toLocaleDateString([],{weekday:'long',month:'short',day:'numeric'});

  const upcoming=blocks.filter(b=>{const e=b.start+b.duration*60000;return b.duration>0?e>now:b.start>now;});
  let blockedMins=0; upcoming.forEach(b=>{blockedMins+=Math.max(b.duration,0);});
  let bufferMins=0;
  const sorted=[...blocks].sort((a,b)=>a.start-b.start);
  checkAlerts(sorted);

  let dayStart=now, dayEnd=now+60*60000;
  if(sorted.length){const last=sorted[sorted.length-1];dayEnd=Math.max(dayEnd,last.start+Math.max(last.duration,0)*60000+30*60000);}
  const dayDur=dayEnd-dayStart;
  let prev=now; const segs=[];
  sorted.forEach(b=>{
    const bs=b.start,be=b.start+b.duration*60000;
    if(bs>prev){const bm=Math.round((bs-prev)/60000);segs.push({type:'buffer',start:prev,end:bs,mins:bm});if(bs>now)bufferMins+=bm;}
    if(b.duration>0){segs.push({type:b.type==='flex'?'block-flex':'block-fixed',start:bs,end:be,name:b.name});prev=be;}
    else{segs.push({type:b.type==='flex'?'block-flex':'block-fixed',start:bs,end:bs+1000,name:b.name});prev=bs;}
  });

  const tlBar=document.getElementById('timelineBar');
  Array.from(tlBar.querySelectorAll('.tl-segment')).forEach(e=>e.remove());
  if(!isPreset){const pp=Math.min(100,((realNow-dayStart)/dayDur)*100);if(pp>0){const p=document.createElement('div');p.className='tl-segment past-seg';p.style.cssText=`left:0%;width:${pp}%`;tlBar.insertBefore(p,document.getElementById('nowLine'));}}
  segs.forEach(s=>{
    if(s.end<now) return;
    const ss=Math.max(s.start,dayStart),lp=((ss-dayStart)/dayDur)*100,wp=((s.end-ss)/dayDur)*100;
    if(wp<0.5) return;
    const el=document.createElement('div');
    el.className=`tl-segment ${s.type==='buffer'?'buffer-seg':s.type==='block-flex'?'block-flex-seg':'block-fixed-seg'}`;
    el.style.cssText=`left:${lp}%;width:${wp}%`;
    if(wp>8)el.textContent=s.type==='buffer'?`~${s.mins}m`:s.name;
    tlBar.insertBefore(el,document.getElementById('nowLine'));
  });
  document.getElementById('nowLine').style.left=(isPreset?0:Math.min(100,((realNow-dayStart)/dayDur)*100))+'%';
  document.getElementById('tlStart').textContent=isPreset?formatTime(new Date(presetTime)):'Now';
  document.getElementById('tlMid').textContent=formatTime(new Date(dayStart+dayDur/2));
  document.getElementById('tlEnd').textContent=formatTime(new Date(dayEnd));

  const next=sorted.find(b=>b.start>now);
  const nextMins=next?Math.floor((next.start-now)/60000):null;
  document.getElementById('statBlocked').textContent=blockedMins>0?formatMins(blockedMins):'‚Äî';
  document.getElementById('statBlocked').className='val good';
  document.getElementById('statBuffer').textContent=bufferMins>0?formatMins(bufferMins):upcoming.length>0?'0m':'‚Äî';
  document.getElementById('statBuffer').className=`val ${bufferMins<15&&upcoming.length>0?'danger':bufferMins<30&&upcoming.length>0?'warn':'good'}`;
  document.getElementById('statNext').textContent=nextMins!==null?formatMins(nextMins):'‚Äî';
  document.getElementById('statNext').className=`val ${nextMins!==null&&nextMins<10?'danger':nextMins!==null&&nextMins<20?'warn':'good'}`;

  const ab=document.getElementById('alertBanner');
  const alerts=[];
  if(nextMins!==null&&nextMins<10)alerts.push(`"${next.name}" starts in ${formatMins(nextMins)}!`);
  if(bufferMins<15&&upcoming.length>1)alerts.push('Less than 15 min of buffer left today.');
  ab.style.display=alerts.length?'flex':'none';
  if(alerts.length)document.getElementById('alertText').textContent=alerts[0];

  const container=document.getElementById('blocksContainer');
  if(!blocks.length){container.innerHTML=`<div class="empty"><div class="icon">üìÖ</div>No events yet.<br>Add your first block above.</div>`;return;}

  let html='<div class="blocks-list">';
  sorted.forEach((b,i)=>{
    const ms=b.start-now, be=b.start+b.duration*60000;
    const isPast=b.duration>0?be<now:b.start<now;
    const isUrg=!isPast&&ms<10*60000, isWarn=!isPast&&!isUrg&&ms<20*60000;
    const isFlex=b.type==='flex';
    const sc=isPast?'past':isUrg?'urgent':isWarn?'warning':'';
    const cd=formatCountdown(Math.max(0,ms));
    const bAt=b.addedAt||(b.start-3600000);
    const pct=isPast?100:Math.min(99,Math.max(0,((now-bAt)/(b.start-bAt))*100));
    const isEd=editingId===b.id;
    const tv=`${pad(new Date(b.start).getHours())}:${pad(new Date(b.start).getMinutes())}`;

    html+=`<div class="block-card ${sc} ${isFlex?'flex-type':''}" data-id="${b.id}">
      <div class="block-inner">
        <div class="block-top">
          <div class="block-left">
            <div class="type-icon">${isFlex?'‚úèÔ∏è':'üîí'}</div>
            <div>
              <div class="block-name">${b.name}</div>
              <div class="block-meta">${formatTime(new Date(b.start))}${b.duration>0?` ¬∑ ${formatMins(b.duration)}`:' ¬∑ deadline'}</div>
              <div class="block-type-badge ${isFlex?'flex':'fixed'}">${isFlex?'flexible':'fixed'}</div>
              ${isFlex&&!isPast?`<button class="edit-time-btn" onclick="openEdit(${b.id})">‚úèÔ∏è change time</button>`:''}
            </div>
          </div>
          <div class="block-right">
            ${isPast?`<div class="block-countdown">‚úì done</div>`:`<div class="block-countdown">${cd}</div><div class="block-status">${isUrg?'‚ö° soon':'to start'}</div>`}
          </div>
          <button class="del-btn" onclick="removeBlock(${b.id})">‚úï</button>
        </div>
        <div class="inline-edit ${isEd?'open':''}">
          <div class="inline-edit-row">
            <input type="time" id="et-${b.id}" value="${tv}" onkeydown="if(event.key==='Enter')saveEdit(${b.id})" />
            <button class="inline-save" onclick="saveEdit(${b.id})">Save</button>
            <button class="inline-cancel" onclick="closeEdit()">‚úï</button>
          </div>
          <div class="inline-note" id="en-${b.id}">‚ö† Overlaps a fixed block</div>
        </div>
      </div>
      <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
    </div>`;

    const nb=sorted[i+1];
    if(nb&&!isPast){const ce=b.duration>0?be:b.start;const gm=Math.round((nb.start-ce)/60000);if(gm>0){const bc=gm<10?'danger-buf':gm<20?'warn-buf':'';const dot=gm<10?'üî¥':gm<20?'üü°':'üü¢';html+=`<div class="buffer-connector ${bc}"><span class="buf-label">${dot} buffer</span><span class="buf-time">${formatMins(gm)} free</span></div>`;}}
  });
  html+='</div>';
  container.innerHTML=html;
}

function setDefaultTime() {
  const d=new Date(); d.setHours(d.getHours()+1,0,0,0);
  document.getElementById('startTime').value=`${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
document.getElementById('eventName').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('startTime').focus();});
document.getElementById('presetTimeInput').addEventListener('keydown',e=>{if(e.key==='Enter')applyPreset();});
setDefaultTime(); render(); setInterval(render,1000);
</script>
<script>if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{});});}</script>
</body>
</html>
